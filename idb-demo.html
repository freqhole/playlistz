<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Reactive Notes Demo</title>
    <script type="module">
      import { openDB } from "https://cdn.jsdelivr.net/npm/idb@7/+esm";
      import microdiff from "https://cdn.jsdelivr.net/npm/microdiff@1.3.2/+esm";

      function createSignal(initial) {
        let value = initial;
        const subs = new Set();
        return {
          get: () => value,
          set: (newVal) => {
            if (value !== newVal) {
              value = newVal;
              subs.forEach((fn) => fn(value));
            }
          },
          subscribe: (fn) => {
            subs.add(fn);
            fn(value);
            return () => subs.delete(fn);
          },
        };
      }

      function createLiveQuery({
        dbName,
        storeName,
        queryFn,
        fields = [],
        limit = null,
      }) {
        const signal = createSignal([]);
        const bc = new BroadcastChannel(`${dbName}-changes`);
        let last = [];

        async function fetchAndUpdate() {
          const db = await openDB(dbName);
          const tx = db.transaction(storeName);
          let items = await tx.objectStore(storeName).getAll();

          if (queryFn) items = items.filter(queryFn);
          if (limit) items = items.slice(0, limit);

          const filtered = items.map((item) => {
            const out = { id: item.id };
            for (const f of fields) out[f] = item[f];
            return out;
          });

          const diff = microdiff(last, filtered);
          if (diff.length > 0) {
            last = filtered;
            signal.set(filtered);
          }
        }

        bc.onmessage = (e) => {
          if (e.data?.type === "mutation" && e.data.store === storeName) {
            fetchAndUpdate();
          }
        };

        fetchAndUpdate();

        return signal;
      }

      async function mutateAndNotify({ dbName, storeName, key, updateFn }) {
        const db = await openDB(dbName);
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        const current = await store.get(key);
        const updated = await updateFn(current || { id: key });
        await store.put(updated);
        await tx.done;

        const bc = new BroadcastChannel(`${dbName}-changes`);
        bc.postMessage({ type: "mutation", store: storeName, id: key });
      }

      function createRelativeTimeSignal(timestamp) {
        const signal = createSignal("");
        function update() {
          const now = Date.now();
          const diff = now - timestamp;
          let label;
          if (diff < 60000) label = "just now";
          else if (diff < 3600000)
            label = `${Math.floor(diff / 60000)} minutes ago`;
          else if (diff < 86400000)
            label = `${Math.floor(diff / 3600000)} hours ago`;
          else label = `${Math.floor(diff / 86400000)} days ago`;
          signal.set(label);
        }
        update();
        const interval = setInterval(update, 60000);
        return { signal, destroy: () => clearInterval(interval) };
      }

      // --- Demo: Notes App ---
      const DB_NAME = "notedb";
      const STORE = "notes";

      async function setupDB() {
        await openDB(DB_NAME, 1, {
          upgrade(db) {
            if (!db.objectStoreNames.contains(STORE)) {
              db.createObjectStore(STORE, { keyPath: "id" });
            }
          },
        });
      }

      await setupDB();

      const sidebarEl = document.getElementById("sidebar");
      const form = document.getElementById("form");
      const input = document.getElementById("note-title");

      const notesSignal = createLiveQuery({
        dbName: DB_NAME,
        storeName: STORE,
        fields: ["title", "createdAt"],
        limit: 25,
      });

      notesSignal.subscribe((notes) => {
        sidebarEl.innerHTML = "";
        for (const note of notes) {
          const { signal: timeSignal } = createRelativeTimeSignal(
            note.createdAt
          );
          const item = document.createElement("li");
          const span = document.createElement("span");
          span.textContent = note.title + " â€“ ";
          const time = document.createElement("em");
          timeSignal.subscribe((label) => (time.textContent = label));
          item.appendChild(span);
          item.appendChild(time);
          sidebarEl.appendChild(item);
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = input.value.trim();
        if (!title) return;
        const id = crypto.randomUUID();
        const now = Date.now();
        await mutateAndNotify({
          dbName: DB_NAME,
          storeName: STORE,
          key: id,
          updateFn: () => ({
            id,
            title,
            createdAt: now,
            content: "",
          }),
        });
        input.value = "";
      });
    </script>
  </head>
  <body>
    <h1>Reactive Notes</h1>
    <form id="form">
      <input id="note-title" placeholder="Add a note title..." />
      <button type="submit">Add</button>
    </form>
    <ul id="sidebar"></ul>
  </body>
</html>
